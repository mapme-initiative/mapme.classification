<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calibration of classifier algorithm • mapme.classification</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calibration of classifier algorithm">
<meta property="og:description" content="mapme.classification">
<meta property="og:image" content="/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapme.classification</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/introduction.html">Introduction</a>
    </li>
    <li>
      <a href="../articles/installation.html">Installation</a>
    </li>
    <li>
      <a href="../articles/terminology.html">Terminology</a>
    </li>
    <li>
      <a href="../articles/workflow.html">Workflow</a>
    </li>
    <li>
      <a href="../articles/classification.html">Supervised Classification</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="classification_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Calibration of classifier algorithm</h1>
            
            <h4 class="date">Last modified: 2021-10-21</h4>
      
      
      <div class="hidden name"><code>classification.Rmd</code></div>

    </div>

    
    
<div id="preprocessing-of-input-data" class="section level2">
<h2 class="hasAnchor">
<a href="#preprocessing-of-input-data" class="anchor"></a>Preprocessing of input data</h2>
<p>First let’s load some packages that we are going to need for the process.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mapme.classification</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/terra/">terra</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></code></pre></div>
<p>Here, we assume that a 10-daily NDVI time series spanning the year 2020 processed by the <code>{mapme.vegetation}</code> package is already available. We are using this time-series as a multi-temporal predictor set but the functionality also applies to other possible predictor sets. Note, that in order to save us some trouble with the <code><a href="https://rdrr.io/pkg/terra/man/predict.html">predict()</a></code> function when applying the model we change the names of the layers to something creating less confusion (for example in our tests, predictors including an hyphen tend to cause some trouble when actually using the model for predictions).</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># read data</span>
<span class="va">files</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata/indices"</span>, package <span class="op">=</span> <span class="st">"mapme.classification"</span><span class="op">)</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">predictors</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/rast.html">rast</a></span><span class="op">(</span><span class="va">files</span><span class="op">)</span>
<span class="va">predictors</span> <span class="op">=</span>  <span class="op">(</span><span class="va">predictors</span> <span class="op">-</span> <span class="fl">1427</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10000</span> <span class="co"># apply scale and offset (only for package data)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html">names</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_replace.html">str_replace_all</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html">names</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span>, <span class="st">"-"</span>, <span class="st">"\\."</span><span class="op">)</span> 
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span></code></pre></div>
<p><img src="classification_files/figure-html/predictors-1.png" width="768"></p>
<p>In addition to the predictors we will read a polygon object indicating the location of known land uses. We will use this objects to get some samples where we know the class label that can be used during model fit. Note, that these polygons have been digitized on screen.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"reference.gpkg"</span>, package <span class="op">=</span> <span class="st">"mapme.classification"</span><span class="op">)</span>, quiet <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="va">aoi</span><span class="op">$</span><span class="va">id</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">aoi</span><span class="op">)</span> <span class="co"># give it a unique ID, important for extraction</span>
<span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span><span class="va">aoi</span>, <span class="fl">100</span><span class="op">)</span>
<span class="va">aoi</span>
<span class="co">#&gt; Simple feature collection with 58 features and 3 fields</span>
<span class="co">#&gt; Geometry type: POLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 243051.4 ymin: 1467726 xmax: 252508.2 ymax: 1476557</span>
<span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 37N</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;                CNAME CID                           geom id</span>
<span class="co">#&gt; 1  Sparse Vegetation   4 POLYGON ((245389.6 1468778,...  1</span>
<span class="co">#&gt; 2  Sparse Vegetation   4 POLYGON ((245439.2 1468775,...  2</span>
<span class="co">#&gt; 3  Sparse Vegetation   4 POLYGON ((245522.3 1468711,...  3</span>
<span class="co">#&gt; 4  Sparse Vegetation   4 POLYGON ((246505.5 1474859,...  4</span>
<span class="co">#&gt; 5  Sparse Vegetation   4 POLYGON ((246851.3 1473816,...  5</span>
<span class="co">#&gt; 6  Sparse Vegetation   4 POLYGON ((246862.2 1473675,...  6</span>
<span class="co">#&gt; 7  Sparse Vegetation   4 POLYGON ((247003.9 1473023,...  7</span>
<span class="co">#&gt; 8  Sparse Vegetation   4 POLYGON ((247031.8 1472903,...  8</span>
<span class="co">#&gt; 9  Sparse Vegetation   4 POLYGON ((247050.2 1472875,...  9</span>
<span class="co">#&gt; 10 Sparse Vegetation   4 POLYGON ((247050.8 1472834,... 10</span></code></pre></div>
<p>We see that we have a total number of 58 polygons associated with different classes or labels found in the column <code>CNAME</code>. We can investigate the class distribution with the <code><a href="https://rdrr.io/r/base/table.html">table()</a></code> function. In general, the samples are evenly distributed among the classes with agriculture showing the lowest object number with 9 and Burnt vegetation the highest number with 14. In total, we have 5 different land use classes.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/table.html">table</a></span><span class="op">(</span><span class="va">aoi</span><span class="op">$</span><span class="va">CNAME</span><span class="op">)</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;          Agriculture     Burnt Vegetation Shrub and tree cover </span>
<span class="co">#&gt;                    9                   14                   11 </span>
<span class="co">#&gt;    Sparse Vegetation                Water </span>
<span class="co">#&gt;                   13                   11</span></code></pre></div>
<p>In the next step we are simulating a spatial stratification of the sampling locations. We will split up the entire AOI into 4 quadrants of equal size and include the information in which quadrant the quadrant of a sample lies in the data.frame. This way, later we can split our data set into training and testing equally against our 4 spatial units as well as telling the model to create space-folds to be used during cross-validation. We will take a closer look at what both of these aspects mean later on in this vignette.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">h</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html">nrow</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">v</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html">ncol</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">agg</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/aggregate.html">aggregate</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, fact <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="va">h</span>,<span class="va">v</span><span class="op">)</span><span class="op">)</span>
<span class="va">agg</span><span class="op">[</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/terra/man/dimensions.html">ncell</a></span><span class="op">(</span><span class="va">agg</span><span class="op">)</span>
<span class="va">quadrants</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/as.spatvector.html">as.polygons</a></span><span class="op">(</span><span class="va">agg</span><span class="op">)</span>
<span class="va">quadrants</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="va">quadrants</span><span class="op">)</span>
<span class="va">aoi</span><span class="op">$</span><span class="va">quad</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Qd"</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_pred.html">st_within</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_centroid</a></span><span class="op">(</span><span class="va">aoi</span> <span class="op">)</span>, <span class="va">quadrants</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">"-"</span><span class="op">)</span><span class="op">)</span>
<span class="va">aoi</span>
<span class="co">#&gt; Simple feature collection with 58 features and 4 fields</span>
<span class="co">#&gt; Geometry type: POLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 243051.4 ymin: 1467726 xmax: 252508.2 ymax: 1476557</span>
<span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 37N</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;                CNAME CID                           geom id quad</span>
<span class="co">#&gt; 1  Sparse Vegetation   4 POLYGON ((245389.6 1468778,...  1 Qd-3</span>
<span class="co">#&gt; 2  Sparse Vegetation   4 POLYGON ((245439.2 1468775,...  2 Qd-3</span>
<span class="co">#&gt; 3  Sparse Vegetation   4 POLYGON ((245522.3 1468711,...  3 Qd-3</span>
<span class="co">#&gt; 4  Sparse Vegetation   4 POLYGON ((246505.5 1474859,...  4 Qd-1</span>
<span class="co">#&gt; 5  Sparse Vegetation   4 POLYGON ((246851.3 1473816,...  5 Qd-1</span>
<span class="co">#&gt; 6  Sparse Vegetation   4 POLYGON ((246862.2 1473675,...  6 Qd-1</span>
<span class="co">#&gt; 7  Sparse Vegetation   4 POLYGON ((247003.9 1473023,...  7 Qd-1</span>
<span class="co">#&gt; 8  Sparse Vegetation   4 POLYGON ((247031.8 1472903,...  8 Qd-1</span>
<span class="co">#&gt; 9  Sparse Vegetation   4 POLYGON ((247050.2 1472875,...  9 Qd-3</span>
<span class="co">#&gt; 10 Sparse Vegetation   4 POLYGON ((247050.8 1472834,... 10 Qd-3</span></code></pre></div>
<p>From the output above, we see that each object now is associated with the information in which quadrant it lies. For now, we will use this information to create a training and test split. Here, for us it is important that during testing we test against objects within all locations and that we not exclude a certain location from the test set, e.g. through completly random sampling. Additionally, we would also wish to retain a similar class distribution between the training and test set so that we do not add any biases by differing distributions. Here we can use the <code><a href="../reference/train_split.html">train_split()</a></code> function from the <code>{mapme.classification}</code> package. It works by handing over an <code>sf</code> object together with an column uniquely identifying each object and the response variable. As a default, the function will try to equally distribute the response variable among the training and test data set. If the response is numerical, it can be split into categories using base R’s <code><a href="https://rdrr.io/r/base/cut.html">cut()</a></code> function via the <code>...</code> argument. Additionally, a grouping variable can be included to stratify the split by this variable. Parameter <code>p</code> indicates the percentage that should go into the training set. To ensure reproducibility of the split, make sure to explicitly set a seed.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">aoi2</span> <span class="op">=</span> <span class="fu"><a href="../reference/train_split.html">train_split</a></span><span class="op">(</span>
  <span class="va">aoi</span>,
  idcol <span class="op">=</span> <span class="st">"id"</span>,
  response <span class="op">=</span> <span class="st">"CNAME"</span>,
  group <span class="op">=</span> <span class="st">"quad"</span>,
  p <span class="op">=</span> <span class="fl">0.5</span>,
  seed <span class="op">=</span> <span class="fl">32</span>,
  verbose <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; Distribution of train set:</span>
<span class="co">#&gt;                       </span>
<span class="co">#&gt;                        Qd-1 Qd-2 Qd-3 Qd-4</span>
<span class="co">#&gt;   Agriculture             0    2    2    0</span>
<span class="co">#&gt;   Burnt Vegetation        2    1    3    1</span>
<span class="co">#&gt;   Shrub and tree cover    1    2    1    2</span>
<span class="co">#&gt;   Sparse Vegetation       2    0    3    1</span>
<span class="co">#&gt;   Water                   0    0    2    3</span>
<span class="co">#&gt; 02120212002313201213</span>
<span class="co">#&gt; Distribution of test set:</span>
<span class="co">#&gt;                       </span>
<span class="co">#&gt;                        Qd-1 Qd-2 Qd-3 Qd-4</span>
<span class="co">#&gt;   Agriculture             1    2    2    0</span>
<span class="co">#&gt;   Burnt Vegetation        2    1    3    1</span>
<span class="co">#&gt;   Shrub and tree cover    1    1    1    2</span>
<span class="co">#&gt;   Sparse Vegetation       3    0    3    1</span>
<span class="co">#&gt;   Water                   0    0    3    3</span>
<span class="co">#&gt; 12130211002313301213</span>
<span class="co">#&gt; Simple feature collection with 58 features and 5 fields</span>
<span class="co">#&gt; Geometry type: POLYGON</span>
<span class="co">#&gt; Dimension:     XY</span>
<span class="co">#&gt; Bounding box:  xmin: 243051.4 ymin: 1467726 xmax: 252508.2 ymax: 1476557</span>
<span class="co">#&gt; Projected CRS: WGS 84 / UTM zone 37N</span>
<span class="co">#&gt; First 10 features:</span>
<span class="co">#&gt;                CNAME CID                           geom id quad split</span>
<span class="co">#&gt; 1  Sparse Vegetation   4 POLYGON ((245389.6 1468778,...  1 Qd-3 train</span>
<span class="co">#&gt; 2  Sparse Vegetation   4 POLYGON ((245439.2 1468775,...  2 Qd-3 train</span>
<span class="co">#&gt; 3  Sparse Vegetation   4 POLYGON ((245522.3 1468711,...  3 Qd-3  test</span>
<span class="co">#&gt; 4  Sparse Vegetation   4 POLYGON ((246505.5 1474859,...  4 Qd-1 train</span>
<span class="co">#&gt; 5  Sparse Vegetation   4 POLYGON ((246851.3 1473816,...  5 Qd-1  test</span>
<span class="co">#&gt; 6  Sparse Vegetation   4 POLYGON ((246862.2 1473675,...  6 Qd-1  test</span>
<span class="co">#&gt; 7  Sparse Vegetation   4 POLYGON ((247003.9 1473023,...  7 Qd-1 train</span>
<span class="co">#&gt; 8  Sparse Vegetation   4 POLYGON ((247031.8 1472903,...  8 Qd-1  test</span>
<span class="co">#&gt; 9  Sparse Vegetation   4 POLYGON ((247050.2 1472875,...  9 Qd-3  test</span>
<span class="co">#&gt; 10 Sparse Vegetation   4 POLYGON ((247050.8 1472834,... 10 Qd-3  test</span></code></pre></div>
<p>In the verbose mode the function messages the distribution if classes for both the training and test set. We see that the classes are not distributed identically but very similar. The resulting <code>sf</code> object now shows an additional column called <code>split</code> which specifies if a specific observation belongs to the train or test sample.</p>
<p>With this information at hand we can now begin to extract our predictors. In the present case we are extracting all pixels within a polygon and associated it with the respective class label. We can use the <code><a href="../reference/extract_traindata.html">extract_traindata()</a></code> function for this.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">traindata</span> <span class="op">=</span> <span class="fu"><a href="../reference/extract_traindata.html">extract_traindata</a></span><span class="op">(</span>
  <span class="va">aoi2</span>,
  <span class="va">predictors</span>,
  verbose <span class="op">=</span> <span class="cn">T</span><span class="op">)</span>
<span class="co">#&gt; Coercing sf object to SpatVect.</span>
<span class="co">#&gt; Checking projections.</span>
<span class="co">#&gt; Starting extraction. This might take a while...</span>
<span class="co">#&gt; Joining aoi metadata with extracted values.</span>
<span class="va">traindata</span><span class="op">$</span><span class="va">CNAME</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html">as.factor</a></span><span class="op">(</span><span class="va">traindata</span><span class="op">$</span><span class="va">CNAME</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/headtail.html">head</a></span><span class="op">(</span><span class="va">traindata</span><span class="op">)</span>
<span class="co">#&gt;               CNAME CID id quad split NDVI.2020.01.06 NDVI.2020.01.16</span>
<span class="co">#&gt; 1 Sparse Vegetation   4  1 Qd-3 train          0.2106          0.2019</span>
<span class="co">#&gt; 2 Sparse Vegetation   4  1 Qd-3 train          0.1834          0.1775</span>
<span class="co">#&gt; 3 Sparse Vegetation   4  1 Qd-3 train          0.2177          0.2092</span>
<span class="co">#&gt; 4 Sparse Vegetation   4  1 Qd-3 train          0.1999          0.1998</span>
<span class="co">#&gt; 5 Sparse Vegetation   4  1 Qd-3 train          0.1575          0.1554</span>
<span class="co">#&gt; 6 Sparse Vegetation   4  1 Qd-3 train          0.1960          0.1964</span>
<span class="co">#&gt;   NDVI.2020.01.26 NDVI.2020.02.05 NDVI.2020.02.15 NDVI.2020.02.25</span>
<span class="co">#&gt; 1          0.1878          0.1784          0.1769          0.1603</span>
<span class="co">#&gt; 2          0.1694          0.1633          0.1638          0.1503</span>
<span class="co">#&gt; 3          0.1942          0.1817          0.1771          0.1540</span>
<span class="co">#&gt; 4          0.1934          0.1857          0.1823          0.1688</span>
<span class="co">#&gt; 5          0.1483          0.1431          0.1422          0.1316</span>
<span class="co">#&gt; 6          0.1913          0.1866          0.1861          0.1681</span>
<span class="co">#&gt;   NDVI.2020.03.06 NDVI.2020.03.16 NDVI.2020.03.26 NDVI.2020.04.05</span>
<span class="co">#&gt; 1          0.1565          0.1599          0.1623          0.1715</span>
<span class="co">#&gt; 2          0.1470          0.1467          0.1418          0.1486</span>
<span class="co">#&gt; 3          0.1465          0.1420          0.1325          0.1392</span>
<span class="co">#&gt; 4          0.1656          0.1610          0.1583          0.1624</span>
<span class="co">#&gt; 5          0.1298          0.1290          0.1281          0.1322</span>
<span class="co">#&gt; 6          0.1659          0.1616          0.1590          0.1672</span>
<span class="co">#&gt;   NDVI.2020.04.15 NDVI.2020.04.25 NDVI.2020.05.05 NDVI.2020.05.15</span>
<span class="co">#&gt; 1          0.1802          0.1901          0.1799          0.1660</span>
<span class="co">#&gt; 2          0.1580          0.1550          0.1353          0.1514</span>
<span class="co">#&gt; 3          0.1572          0.1584          0.1521          0.1839</span>
<span class="co">#&gt; 4          0.1718          0.1772          0.1766          0.1655</span>
<span class="co">#&gt; 5          0.1388          0.1427          0.1369          0.1175</span>
<span class="co">#&gt; 6          0.1784          0.1834          0.1782          0.1745</span>
<span class="co">#&gt;   NDVI.2020.05.25 NDVI.2020.06.04 NDVI.2020.06.14 NDVI.2020.06.24</span>
<span class="co">#&gt; 1          0.1684          0.1896          0.2510          0.3457</span>
<span class="co">#&gt; 2          0.1896          0.2464          0.3385          0.4467</span>
<span class="co">#&gt; 3          0.2399          0.3123          0.4115          0.5157</span>
<span class="co">#&gt; 4          0.1634          0.1690          0.1915          0.2291</span>
<span class="co">#&gt; 5          0.1188          0.1332          0.1642          0.2119</span>
<span class="co">#&gt; 6          0.1794          0.1954          0.2453          0.3181</span>
<span class="co">#&gt;   NDVI.2020.07.04 NDVI.2020.07.14 NDVI.2020.07.24 NDVI.2020.08.03</span>
<span class="co">#&gt; 1          0.4545          0.5868          0.6720          0.7389</span>
<span class="co">#&gt; 2          0.5507          0.6779          0.7334          0.7524</span>
<span class="co">#&gt; 3          0.6113          0.7081          0.7854          0.8114</span>
<span class="co">#&gt; 4          0.2663          0.3105          0.3524          0.3894</span>
<span class="co">#&gt; 5          0.2569          0.3053          0.3426          0.3684</span>
<span class="co">#&gt; 6          0.3969          0.5053          0.5502          0.5855</span>
<span class="co">#&gt;   NDVI.2020.08.13 NDVI.2020.08.23 NDVI.2020.09.02 NDVI.2020.09.12</span>
<span class="co">#&gt; 1          0.7620          0.7322          0.6791          0.6145</span>
<span class="co">#&gt; 2          0.7435          0.7411          0.7128          0.6655</span>
<span class="co">#&gt; 3          0.8042          0.8004          0.7892          0.7699</span>
<span class="co">#&gt; 4          0.4131          0.4131          0.4096          0.3954</span>
<span class="co">#&gt; 5          0.3782          0.3651          0.3613          0.3486</span>
<span class="co">#&gt; 6          0.5959          0.5916          0.5766          0.5416</span>
<span class="co">#&gt;   NDVI.2020.09.22 NDVI.2020.10.02 NDVI.2020.10.12 NDVI.2020.10.22</span>
<span class="co">#&gt; 1          0.5526          0.4982          0.4494          0.4084</span>
<span class="co">#&gt; 2          0.6100          0.5456          0.4765          0.4142</span>
<span class="co">#&gt; 3          0.7426          0.7072          0.6557          0.5950</span>
<span class="co">#&gt; 4          0.3721          0.3433          0.3023          0.2611</span>
<span class="co">#&gt; 5          0.3284          0.3059          0.2730          0.2385</span>
<span class="co">#&gt; 6          0.5028          0.4619          0.4145          0.3718</span>
<span class="co">#&gt;   NDVI.2020.11.01 NDVI.2020.11.11 NDVI.2020.11.21 NDVI.2020.12.01</span>
<span class="co">#&gt; 1          0.3480          0.3145          0.2821          0.2544</span>
<span class="co">#&gt; 2          0.3196          0.2614          0.2258          0.2021</span>
<span class="co">#&gt; 3          0.5336          0.4586          0.3777          0.3078</span>
<span class="co">#&gt; 4          0.2276          0.2087          0.1980          0.1924</span>
<span class="co">#&gt; 5          0.2071          0.1873          0.1789          0.1741</span>
<span class="co">#&gt; 6          0.2897          0.2484          0.2251          0.2118</span>
<span class="co">#&gt;   NDVI.2020.12.11 NDVI.2020.12.21 NDVI.2020.12.31</span>
<span class="co">#&gt; 1          0.2315          0.2132          0.1992</span>
<span class="co">#&gt; 2          0.1881          0.1817          0.1807</span>
<span class="co">#&gt; 3          0.2582          0.2380          0.2562</span>
<span class="co">#&gt; 4          0.1903          0.1903          0.1909</span>
<span class="co">#&gt; 5          0.1708          0.1666          0.1593</span>
<span class="co">#&gt; 6          0.2063          0.2066          0.2106</span></code></pre></div>
<p>As you can see, the attributes from the <code>aoi2</code> object are retained. However, we now longer have an <code>sf</code> object but rather a simple data.frame. We also see a number of new columns coressponding to the names of our predictor data set. We also see that the value in the column <code>id</code> is repeated several times. This means that for the first object we actually extracted three different pixels that lie within that polygon. This is of course create because we get a higher number of observations (1377 in total), but because these observations actually come from the same object they are not really what statisticians call independent. This is one reason why we conducted the training split before extracting so that we can make sure that no pixels from the same object are included in both, training and test. For now, let’s try to visualize the extracted data and see if we are able to find some differences among the land use classes.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">traindata</span> <span class="op">%&gt;%</span>
  <span class="va">as_tibble</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span><span class="fl">6</span><span class="op">:</span><span class="fl">42</span>, names_to <span class="op">=</span> <span class="st">"predictor"</span>, values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">predictor</span>,<span class="fl">6</span>,<span class="fl">15</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">"%Y.%m.%d"</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_smooth.html">geom_smooth</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span><span class="va">time</span>,y<span class="op">=</span><span class="va">value</span>,color<span class="op">=</span><span class="va">CNAME</span><span class="op">)</span>, se <span class="op">=</span> <span class="cn">F</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x<span class="op">=</span><span class="st">"Time"</span>, y<span class="op">=</span><span class="st">"NDVI"</span>,color<span class="op">=</span><span class="st">"Class"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Smoothed NDVI profiles per class in the training split"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span>
<span class="co">#&gt; `geom_smooth()` using method = 'gam' and formula 'y ~ s(x, bs = "cs")'</span></code></pre></div>
<p><img src="classification_files/figure-html/viz-1.png" width="768"></p>
<p>From the above plot we an see the different NDVI curves over the year averaged by land cover class. While agriculture and burnt vegetation show a very similar NDVI curve, other classes are clearly distinct. It is this information included in our training sample that we wish the RandomForest model to learn in order to differentiate between land uses.</p>
</div>
<div id="calibration-of-classifier-algorithm" class="section level2">
<h2 class="hasAnchor">
<a href="#calibration-of-classifier-algorithm" class="anchor"></a>Calibration of classifier algorithm</h2>
<p><code>{mapme.classification}</code> uses the pre-processed training data to map LULC. In the current example, the Random Forest (RF) algorithm is used for this purpose. RF are an ensemble learning method for classification, regression and other tasks, that operate by constructing multiple decision trees during the training stage and outputting the class that is the mode of the classes (classification) or the average prediction (regression) of the individual trees.</p>
<div id="fitting-a-classification-model" class="section level3">
<h3 class="hasAnchor">
<a href="#fitting-a-classification-model" class="anchor"></a>Fitting a classification model</h3>
<p>We have different options on how we would like the training to happen. First, we will have to decide on a model to be used. Note, that in principal all models supported by the <a href="https://github.com/topepo/caret/">caret</a> package can be specified via the <code>method</code> argument. We will use the RF model based on the <a href="https://www.stat.berkeley.edu/~breiman/RandomForests/">randomForest</a> package. It is also a good advise to explicitly state the column names in the traindata object that should be considered as predictors. We also need to tell the model which of the variables is the response variable. It will be automatically deducted based on the datatype whether to conduct a regression or a classification so make sure to properly set the datatype (e.g. character or factor for classification). We also have the possibility to include a variable indicating the spatial and the temporal strata a given observations belongs to. Here we will only specify a spatial variable (the quadrant a observation belongs to) but we could have also taken measurements of a variable at different points in time. During model fit we would like to base our cross-validation on these variables so that we are actually able to measure how well a model performs on a new space-time location. Note, that including a temporal variable in the cross-validation is usually a less common practice during classification but it can be frequently seen with regression problems. The parameter <code>k</code> controls how many folds the cross validation is based on. Please check <code><a href="https://rdrr.io/pkg/caret/man/train.html">caret::train()</a></code> for additional arguments that can be supplied (such as the metric to optimize for). The <code><a href="../reference/train_model.html">train_model()</a></code> function additionally allows us to conduct a forward-future selection based on <code><a href="https://rdrr.io/pkg/CAST/man/ffs.html">CAST::ffs</a></code>. In this mode, during the first round each single predictor will be tested against all other predictors and the best combination will be selected. This is then repeated with all remaining variables until no improvement in the optimization metric is found. This process can be quite computationally expensive because many models might be fit. For this reason we will train the current model without FFS.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">output</span> <span class="op">=</span> <span class="fu"><a href="../reference/train_model.html">train_model</a></span><span class="op">(</span>
  traindata <span class="op">=</span> <span class="va">traindata</span><span class="op">[</span><span class="va">traindata</span><span class="op">$</span><span class="va">split</span> <span class="op">==</span> <span class="st">"train"</span>, <span class="op">]</span>,
  predictors <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html">names</a></span><span class="op">(</span><span class="va">predictors</span><span class="op">)</span>,
  response <span class="op">=</span> <span class="st">"CNAME"</span>,
  spacevar <span class="op">=</span> <span class="st">"quad"</span>,
  k <span class="op">=</span> <span class="fl">5</span>,
  ffs <span class="op">=</span> <span class="cn">F</span>,
  method <span class="op">=</span> <span class="st">"rf"</span>,
  metric <span class="op">=</span> <span class="st">"Accuracy"</span>,
  maximize <span class="op">=</span> <span class="cn">TRUE</span>,
  seed <span class="op">=</span> <span class="fl">32</span>,
  verbose <span class="op">=</span> <span class="cn">T</span>,
  ntree<span class="op">=</span><span class="fl">500</span><span class="op">)</span>
<span class="co">#&gt; Spatiotemporal CV was selected. Setting trControl to CV with space-time index for folds.</span>
<span class="co">#&gt; FFS was not selected. Training model with all predictors...</span>
<span class="co">#&gt; Loading required package: lattice</span>
<span class="co">#&gt; Model type classification. Returning confusion matrix.</span>
<span class="va">output</span><span class="op">$</span><span class="va">model</span>
<span class="co">#&gt; Random Forest </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; 665 samples</span>
<span class="co">#&gt;  37 predictor</span>
<span class="co">#&gt;   5 classes: 'Agriculture', 'Burnt Vegetation', 'Shrub and tree cover', 'Sparse Vegetation', 'Water' </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; No pre-processing</span>
<span class="co">#&gt; Resampling: Cross-Validated (25 fold) </span>
<span class="co">#&gt; Summary of sample sizes: 522, 451, 594, 500, 593 </span>
<span class="co">#&gt; Resampling results across tuning parameters:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;   mtry  Accuracy   Kappa   </span>
<span class="co">#&gt;    2    0.3889208  0.227957</span>
<span class="co">#&gt;   19    0.4140827  0.243893</span>
<span class="co">#&gt;   37    0.4064190  0.236892</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Accuracy was used to select the optimal model using the largest value.</span>
<span class="co">#&gt; The final value used for the model was mtry = 19.</span></code></pre></div>
<p>The function returns a list object with the model in the first position, a confusion matrix in the second positions and the observed and predicted vectors following. Considering the model output we see above we see that we have an overall accuracy of only about 41%. What is this estimate based on? During model fit, observations from certain quadtrants have been held out of training and the model is then evaluated based on this data. Unfortunatley, we only have a very small amount of training data. Thus in order to get a more reliable estimate of the model fit we should evaluate the model on the hold-out-validation set.</p>
</div>
<div id="assessing-the-accuracy-on-a-held-out-dataset" class="section level3">
<h3 class="hasAnchor">
<a href="#assessing-the-accuracy-on-a-held-out-dataset" class="anchor"></a>Assessing the accuracy on a held-out dataset</h3>
<p>In order to derive a robust indicator of the model’s performance we will use the test set. We can use the <code><a href="../reference/eval_test.html">eval_test()</a></code> function. It expects a trained model as input, the data for which to predict the outcome as well as the column name where the observed outcome is stored.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">evaluated</span> <span class="op">=</span> <span class="fu"><a href="../reference/eval_test.html">eval_test</a></span><span class="op">(</span>
  <span class="va">output</span><span class="op">$</span><span class="va">model</span>,
  <span class="va">traindata</span><span class="op">[</span><span class="va">traindata</span><span class="op">$</span><span class="va">split</span> <span class="op">==</span> <span class="st">"test"</span>, <span class="op">]</span>,
  response <span class="op">=</span> <span class="st">"CNAME"</span><span class="op">)</span>

<span class="va">evaluated</span><span class="op">$</span><span class="va">cnf</span>
<span class="co">#&gt; Confusion Matrix and Statistics</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                       Reference</span>
<span class="co">#&gt; Prediction             Agriculture Burnt Vegetation Shrub and tree cover</span>
<span class="co">#&gt;   Agriculture                   66               11                   19</span>
<span class="co">#&gt;   Burnt Vegetation              23              135                   15</span>
<span class="co">#&gt;   Shrub and tree cover          14                2                   68</span>
<span class="co">#&gt;   Sparse Vegetation             10               16                   11</span>
<span class="co">#&gt;   Water                          4                2                    4</span>
<span class="co">#&gt;                       Reference</span>
<span class="co">#&gt; Prediction             Sparse Vegetation Water</span>
<span class="co">#&gt;   Agriculture                         26     5</span>
<span class="co">#&gt;   Burnt Vegetation                     3     6</span>
<span class="co">#&gt;   Shrub and tree cover                 4    16</span>
<span class="co">#&gt;   Sparse Vegetation                  134    21</span>
<span class="co">#&gt;   Water                                0    97</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Overall Statistics</span>
<span class="co">#&gt;                                           </span>
<span class="co">#&gt;                Accuracy : 0.7022          </span>
<span class="co">#&gt;                  95% CI : (0.6672, 0.7356)</span>
<span class="co">#&gt;     No Information Rate : 0.2346          </span>
<span class="co">#&gt;     P-Value [Acc &gt; NIR] : &lt; 2.2e-16       </span>
<span class="co">#&gt;                                           </span>
<span class="co">#&gt;                   Kappa : 0.6246          </span>
<span class="co">#&gt;                                           </span>
<span class="co">#&gt;  Mcnemar's Test P-Value : 5.012e-10       </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Statistics by Class:</span>
<span class="co">#&gt; </span>
<span class="co">#&gt;                      Class: Agriculture Class: Burnt Vegetation</span>
<span class="co">#&gt; Sensitivity                      0.5641                  0.8133</span>
<span class="co">#&gt; Specificity                      0.8975                  0.9139</span>
<span class="co">#&gt; Pos Pred Value                   0.5197                  0.7418</span>
<span class="co">#&gt; Neg Pred Value                   0.9128                  0.9415</span>
<span class="co">#&gt; Precision                        0.5197                  0.7418</span>
<span class="co">#&gt; Recall                           0.5641                  0.8133</span>
<span class="co">#&gt; F1                               0.5410                  0.7759</span>
<span class="co">#&gt; Prevalence                       0.1643                  0.2331</span>
<span class="co">#&gt; Detection Rate                   0.0927                  0.1896</span>
<span class="co">#&gt; Detection Prevalence             0.1784                  0.2556</span>
<span class="co">#&gt; Balanced Accuracy                0.7308                  0.8636</span>
<span class="co">#&gt;                      Class: Shrub and tree cover Class: Sparse Vegetation</span>
<span class="co">#&gt; Sensitivity                              0.58120                   0.8024</span>
<span class="co">#&gt; Specificity                              0.93950                   0.8936</span>
<span class="co">#&gt; Pos Pred Value                           0.65385                   0.6979</span>
<span class="co">#&gt; Neg Pred Value                           0.91941                   0.9365</span>
<span class="co">#&gt; Precision                                0.65385                   0.6979</span>
<span class="co">#&gt; Recall                                   0.58120                   0.8024</span>
<span class="co">#&gt; F1                                       0.61538                   0.7465</span>
<span class="co">#&gt; Prevalence                               0.16433                   0.2346</span>
<span class="co">#&gt; Detection Rate                           0.09551                   0.1882</span>
<span class="co">#&gt; Detection Prevalence                     0.14607                   0.2697</span>
<span class="co">#&gt; Balanced Accuracy                        0.76035                   0.8480</span>
<span class="co">#&gt;                      Class: Water</span>
<span class="co">#&gt; Sensitivity                0.6690</span>
<span class="co">#&gt; Specificity                0.9824</span>
<span class="co">#&gt; Pos Pred Value             0.9065</span>
<span class="co">#&gt; Neg Pred Value             0.9207</span>
<span class="co">#&gt; Precision                  0.9065</span>
<span class="co">#&gt; Recall                     0.6690</span>
<span class="co">#&gt; F1                         0.7698</span>
<span class="co">#&gt; Prevalence                 0.2037</span>
<span class="co">#&gt; Detection Rate             0.1362</span>
<span class="co">#&gt; Detection Prevalence       0.1503</span>
<span class="co">#&gt; Balanced Accuracy          0.8257</span></code></pre></div>
<p>Considering the held-out test set with the present model we achieve an OA of 70% and a Kappa score of 0.62. There is some severe confusion between agriculture and burnt vegetation reducing the sensitivity of the agricultural class to 75% as well as between water and sparse vegetation. The other classes seem to be better separable. In a next step we might be interested in using the model to create a spatial prediction that we can use for further analyses (e.g. areal statistics) or visualization.</p>
</div>
<div id="spatial-prediction-and-area-of-applicability" class="section level3">
<h3 class="hasAnchor">
<a href="#spatial-prediction-and-area-of-applicability" class="anchor"></a>Spatial prediction and area of applicability</h3>
<p>To conduct a spatial prediction we can use the <code><a href="../reference/spatial_predict.html">spatial_predict()</a></code> function that allows us to get a raster including the spatial prediction. Additionally, we can use it to calculate the area of applicability (AOA) of our prediction model. The concept of AOA was introduced by Meyer &amp; Pebesma (2020) and describes the boundaries where a classifier or regression model delivers useful outcomes. These boundaries are set by the available training dataset because we can not expect a model to perform equally well at locations where the predictors deviate substantially from the distribution within the training set. The <a href="https://github.com/HannaMeyer/CAST">CAST</a> package is used to calculate the AOA as well as the diversity index (DI) that is the basis for the AOA calculation. Feel free to read more in the CAST documentation. Since both the prediction and AOA calculation can be computationally intensive for large rasters you can specify the number of cores to be used for parallel computation.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">pred_raster</span> <span class="op">=</span> <span class="fu"><a href="../reference/spatial_predict.html">spatial_predict</a></span><span class="op">(</span>
  predictors <span class="op">=</span> <span class="va">predictors</span>,
  model <span class="op">=</span> <span class="va">output</span><span class="op">$</span><span class="va">model</span>,
  mode <span class="op">=</span> <span class="st">"response"</span>,
  AOA <span class="op">=</span> <span class="cn">T</span>,
  ncores <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<pre><code>#&gt; class       : SpatRaster 
#&gt; dimensions  : 265, 267, 3  (nrow, ncol, nlyr)
#&gt; resolution  : 40, 40  (x, y)
#&gt; extent      : 242123, 252803, 1467643, 1478243  (xmin, xmax, ymin, ymax)
#&gt; coord. ref. : WGS 84 / UTM zone 37N (EPSG:32637) 
#&gt; source      : pred-raster.tif 
#&gt; red-grn-blue: 1, 2, 3 
#&gt; names       :       class, DI, AOA 
#&gt; min values  : Agriculture,  0,   0 
#&gt; max values  :       Water,  0,   1</code></pre>
</div>
<div id="bias-adjusted-area-estimates" class="section level3">
<h3 class="hasAnchor">
<a href="#bias-adjusted-area-estimates" class="anchor"></a>Bias adjusted area estimates</h3>
<p><code>mapme.classification</code> uses confusion matrices and it implements current standards for accuracy assessments and LULC area estimation. More concisely, it uses error matrices to correct bias in the LULC area estimates, was proposed by <span class="citation">Yelena Finegold &amp; Antonia Ortmann (2016)</span> and <span class="citation">Olofsson et al. (2013)</span>. We can use the <code><a href="../reference/area_estimation.html">area_estimation()</a></code> function to derive an adjusted area estimation taking into account the distribution of the training classes. This method delivers adjusted area estimates and also a confidence range for these estimates for each class.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">areast</span> <span class="op">=</span> <span class="fu"><a href="../reference/area_estimation.html">area_estimation</a></span><span class="op">(</span><span class="va">pred_raster</span><span class="op">$</span><span class="va">class</span>, cnf <span class="op">=</span> <span class="va">evaluated</span><span class="op">$</span><span class="va">cnf</span><span class="op">)</span><span class="op">)</span>
<span class="co">#&gt;                  class area_org         area_adj      area_adj.sd</span>
<span class="co">#&gt; 1          Agriculture 11540800 17687601.3564256 2963530.71605651</span>
<span class="co">#&gt; 2     Burnt Vegetation 39755200 39208050.6136067 3124660.51985942</span>
<span class="co">#&gt; 3 Shrub and tree cover 29812800 20764889.8147416 2911194.80031172</span>
<span class="co">#&gt; 4    Sparse Vegetation 21649600 26383012.6458576 2828239.77675223</span>
<span class="co">#&gt; 5                Water  9600000 8314845.56936854 1441750.41080769</span>
<span class="co">#&gt;                  PA              PA.sd                UA              UA.sd</span>
<span class="co">#&gt; 1 0.368065445427389 0.0686186264007139 0.564102564102564 0.0897794231858626</span>
<span class="co">#&gt; 2 0.824601979404664  0.044525881868898 0.813253012048193 0.0591605608317763</span>
<span class="co">#&gt; 3 0.834442060154656  0.051814393918205 0.581196581196581 0.0893248409070239</span>
<span class="co">#&gt; 4 0.658436379594763 0.0648623219879592 0.802395209580838 0.0602661523761192</span>
<span class="co">#&gt; 5 0.772361784947132  0.117001528384831 0.668965517241379 0.0764701335931089</span>
<span class="co">#&gt;                  OA              OA.sd</span>
<span class="co">#&gt; 1 0.711668488934776 0.0355314755594928</span>
<span class="co">#&gt; 2              &lt;NA&gt;               &lt;NA&gt;</span>
<span class="co">#&gt; 3              &lt;NA&gt;               &lt;NA&gt;</span>
<span class="co">#&gt; 4              &lt;NA&gt;               &lt;NA&gt;</span>
<span class="co">#&gt; 5              &lt;NA&gt;               &lt;NA&gt;</span></code></pre></div>
<p>We see that we have very low Producer’s (PA) and User’s accuracy (UA) for agriculture resulting in a wide range of the adjusted area. For other classes the estimated range is much more narrow.</p>
</div>
<div id="post-processing" class="section level3">
<h3 class="hasAnchor">
<a href="#post-processing" class="anchor"></a>Post-Processing</h3>
<p>A common post-processing step especially for visualization can be to filter the classified raster to remove very small patches of one class within another. For this we can use the <code><a href="../reference/postclass.html">postclass()</a></code> function that allows us to apply a zonal statistic in a certain neighborhood size of a pixel. In this example we will return the most frequent class in a 5x5 neighborhood.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">postclass_raster</span> <span class="op">=</span> <span class="fu"><a href="../reference/postclass.html">postclass</a></span><span class="op">(</span>
  <span class="va">pred_raster</span><span class="op">$</span><span class="va">class</span>,
  w <span class="op">=</span> <span class="fl">3</span>,
  fun <span class="op">=</span> <span class="st">"modal"</span>
<span class="op">)</span><span class="op">)</span>
<span class="co">#&gt; class       : SpatRaster </span>
<span class="co">#&gt; dimensions  : 265, 267, 1  (nrow, ncol, nlyr)</span>
<span class="co">#&gt; resolution  : 40, 40  (x, y)</span>
<span class="co">#&gt; extent      : 242123, 252803, 1467643, 1478243  (xmin, xmax, ymin, ymax)</span>
<span class="co">#&gt; coord. ref. : WGS 84 / UTM zone 37N (EPSG:32637) </span>
<span class="co">#&gt; source      : memory </span>
<span class="co">#&gt; name        :       class </span>
<span class="co">#&gt; min value   : Agriculture </span>
<span class="co">#&gt; max value   :       Water</span></code></pre></div>
</div>
<div id="visualization" class="section level3">
<h3 class="hasAnchor">
<a href="#visualization" class="anchor"></a>Visualization</h3>
<p>Let’s finally visualize our results. We will plot both the original raster and the post-classification raster. Also we will mark pixels that are considered as outside of the area of applicability explicitly. Finally, we will give a more intuitive color code for each class.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pred_raster</span><span class="op">$</span><span class="va">class</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/mask.html">mask</a></span><span class="op">(</span><span class="va">pred_raster</span><span class="op">$</span><span class="va">class</span>, <span class="va">pred_raster</span><span class="op">$</span><span class="va">AOA</span>, maskvalues <span class="op">=</span><span class="fl">0</span>, updatevalue<span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/factors.html">levels</a></span><span class="op">(</span><span class="va">pred_raster</span><span class="op">$</span><span class="va">class</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"Agriculture"</span>, <span class="st">"Burnt Vegetation"</span>, <span class="st">"Shrub and tree cover"</span>, <span class="st">"Sparse Vegetation"</span>, <span class="st">"Water"</span>, <span class="st">"not-applicable"</span><span class="op">)</span>
<span class="va">postclass_raster</span> <span class="op">=</span>  <span class="fu"><a href="https://rdrr.io/pkg/terra/man/mask.html">mask</a></span><span class="op">(</span><span class="va">postclass_raster</span>, <span class="va">pred_raster</span><span class="op">$</span><span class="va">AOA</span>, maskvalues <span class="op">=</span><span class="fl">0</span>, updatevalue<span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/factors.html">levels</a></span><span class="op">(</span><span class="va">postclass_raster</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"Agriculture"</span>, <span class="st">"Burnt Vegetation"</span>, <span class="st">"Shrub and tree cover"</span>, <span class="st">"Sparse Vegetation"</span>, <span class="st">"Water"</span>, <span class="st">"not-applicable"</span><span class="op">)</span>
<span class="va">vis</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="va">pred_raster</span><span class="op">$</span><span class="va">class</span>, <span class="va">postclass_raster</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/names.html">names</a></span><span class="op">(</span><span class="va">vis</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"Original"</span>, <span class="st">"Postclass"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/terra/man/plot.html">plot</a></span><span class="op">(</span><span class="va">vis</span>, col <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/terra/man/c.html">c</a></span><span class="op">(</span><span class="st">"orange"</span>, <span class="st">"grey"</span>, <span class="st">"green"</span>, <span class="st">"darkgreen"</span>, <span class="st">"blue"</span>, <span class="st">"black"</span><span class="op">)</span>, legend <span class="op">=</span> <span class="st">"topright"</span>, plg <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>ncol<span class="op">=</span><span class="fl">3</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="classification_files/figure-html/map-1.png" width="768"></p>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-olofsson_making_2013">
<p>Olofsson, Pontus, Giles M Foody, Stephen V Stehman, and Curtis E Woodcock. 2013. “Making Better Use of Accuracy Data in Land Change Studies: Estimating Accuracy and Area and Quantifying Uncertainty Using Stratified Estimatio.” <em>Remote Sensing of Environment.</em> 129 (February): 122–31. <a href="https://doi.org/10.1016/j.rse.2012.10.031">https://doi.org/10.1016/j.rse.2012.10.031</a>.</p>
</div>
<div id="ref-yelena_finegold__antonia_ortmann_map_2016">
<p>Yelena Finegold &amp; Antonia Ortmann. 2016. <em>Map Accuracy Assessment and Area Estimation: A Practical Guide</em>. National Forest Monitoring and Assessment Working Paper 46. Rome, Italy: FAO. <a href="http://www.fao.org/documents/card/en/c/e5ea45b8-3fd7-4692-ba29-fae7b140d07e/">http://www.fao.org/documents/card/en/c/e5ea45b8-3fd7-4692-ba29-fae7b140d07e/</a>.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://mapme-initiative.org/">MAPME-Initiative</a>, <a href="http://dariusgoergen.com/">Darius Görgen</a>.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
